import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());

const PAYPAL_CLIENT_ID = "AZTItKSIoet0uX-vTdaXCE-MlA8ehTm8xRJmLS3phCBsYQtN74-iiNXl1YECmbu4ldznZexblz-893CX";
const PAYPAL_SECRET = "YOUR_PAYPAL_SECRET_HERE"; // from PayPal dashboard
const PAYPAL_API_BASE = "https://api-m.paypal.com"; // or sandbox url

async function getPayPalAccessToken() {
  const auth = Buffer.from(`${PAYPAL_CLIENT_ID}:${PAYPAL_SECRET}`).toString("base64");
  const res = await fetch(`${PAYPAL_API_BASE}/v1/oauth2/token`, {
    method: "POST",
    headers: {
      "Authorization": `Basic ${auth}`,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "grant_type=client_credentials"
  });
  const data = await res.json();
  return data.access_token;
}

app.post("/az-film-credit/checkout", async (req, res) => {
  try {
    const { amount, service_plan, ...project } = req.body;

    const token = await getPayPalAccessToken();

    // 1) Create PayPal order
    const orderRes = await fetch(`${PAYPAL_API_BASE}/v2/checkout/orders`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        intent: "CAPTURE",
        purchase_units: [
          {
            amount: {
              currency_code: "USD",
              value: amount.toFixed(2)
            },
            description:
              service_plan === "prep"
                ? "AZ Film Credit - Document Prep Only"
                : "AZ Film Credit - Document Prep + Certified AZ CPA Sign-Off"
          }
        ]
      })
    });

    const order = await orderRes.json();

    // Here you have options:
    // - If you're doing card vault/hosted fields, you'd capture here after approval.
    // - If you just want server-side capture right away (for already-approved sources),
    //   call /v2/checkout/orders/{orderID}/capture.

    // For now, assume capture is immediate (this depends on your integration type).
    const captureRes = await fetch(
      `${PAYPAL_API_BASE}/v2/checkout/orders/${order.id}/capture`,
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      }
    );
    const captureData = await captureRes.json();

    // TODO: verify captureData.status === "COMPLETED", store in DB, etc.

    res.json({ success: true, orderID: order.id });
  } catch (err) {
    console.error(err);
    res.status(500).json({
      success: false,
      message: "Payment failed. Please try again."
    });
  }
});

