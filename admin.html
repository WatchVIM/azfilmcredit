<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AZ Film Credit — Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { desertGold:"#E3A857", sunsetRed:"#E4572E" } } }
    };
  </script>

  <style>
    :focus-visible { outline: 2px solid #E3A857; outline-offset: 2px; }
  </style>
</head>

<body class="min-h-screen bg-black text-white">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Admin Portal</h1>
        <p class="text-xs text-gray-400 mt-1">Secure order review for AZ Film Credit</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="index.html" class="text-sm text-desertGold underline">Back to site</a>
        <button id="logoutBtn" class="hidden text-sm px-3 py-1.5 rounded bg-white/10 hover:bg-white/15">
          Logout
        </button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="bg-white/5 border border-white/10 rounded-xl p-4 max-w-md">
      <h2 class="text-lg font-semibold mb-2">Admin Login</h2>
      <p class="text-xs text-gray-300 mb-3">
        Enter the admin password to view orders. (Password is stored locally in your browser until logout.)
      </p>

      <label class="block text-xs text-gray-300 mb-1" for="adminPass">Admin password</label>
      <div class="flex gap-2">
        <input
          id="adminPass"
          type="password"
          class="w-full px-3 py-2 rounded bg-black/60 border border-white/15 text-sm"
          placeholder="Admin password"
          autocomplete="current-password"
        />
        <button
          id="togglePassBtn"
          type="button"
          class="px-3 py-2 rounded bg-white/10 hover:bg-white/15 text-xs"
          aria-label="Show password"
        >
          Show
        </button>
      </div>

      <button
        id="loginBtn"
        type="button"
        class="mt-3 w-full px-4 py-2 rounded bg-sunsetRed hover:bg-orange-500 font-semibold disabled:opacity-50"
      >
        Sign in
      </button>

      <p id="loginMsg" class="mt-2 text-xs text-gray-300"></p>

      <div class="mt-3 text-[11px] text-gray-400">
        Troubleshooting:
        <ul class="list-disc ml-4 mt-1 space-y-1">
          <li>If using a Vercel Preview URL, make sure <code>ADMIN_PASSWORD</code> is set for <b>Preview</b> env too.</li>
          <li>If password changed, click Logout or clear stored password.</li>
        </ul>
      </div>
    </div>

    <!-- Orders -->
    <div id="ordersWrap" class="hidden">
      <div class="flex flex-wrap gap-2 items-center mt-6 mb-3">
        <select id="statusFilter" class="px-3 py-2 rounded bg-black/60 border border-white/15 text-sm">
          <option value="">All statuses</option>
          <option value="paid">paid</option>
          <option value="in_review">in_review</option>
          <option value="packet_generated">packet_generated</option>
          <option value="sent_to_cpa">sent_to_cpa</option>
          <option value="completed">completed</option>
          <option value="needs_info">needs_info</option>
        </select>

        <button id="refreshBtn" class="px-4 py-2 rounded bg-white/10 hover:bg-white/15 text-sm">
          Refresh
        </button>

        <div class="ml-auto flex items-center gap-2 text-xs text-gray-300">
          <span class="px-2 py-1 rounded bg-white/10 border border-white/10">
            API: <span id="apiStatus" class="text-gray-200">—</span>
          </span>
        </div>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-xl overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-white/5">
            <tr>
              <th class="text-left p-3">Tracking</th>
              <th class="text-left p-3">Company</th>
              <th class="text-left p-3">Project</th>
              <th class="text-left p-3">Plan</th>
              <th class="text-left p-3">Status</th>
              <th class="text-left p-3">Created</th>
              <th class="text-left p-3">Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-gray-400">
        “Generate CPA Packet” calls <code>/api/generate-packet</code> (admin-only).
      </p>
    </div>
  </div>

  <script>
    const loginCard = document.getElementById("loginCard");
    const ordersWrap = document.getElementById("ordersWrap");
    const adminPassEl = document.getElementById("adminPass");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const ordersBody = document.getElementById("ordersBody");
    const statusFilter = document.getElementById("statusFilter");
    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const togglePassBtn = document.getElementById("togglePassBtn");
    const apiStatus = document.getElementById("apiStatus");

    const STORAGE_KEY = "azfc_admin_pass";

    function escHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    function badge(status) {
      const base = "inline-flex px-2 py-0.5 rounded-full text-xs border";
      if (status === "paid") return `<span class="${base} border-desertGold/40 text-desertGold">paid</span>`;
      if (status === "packet_generated") return `<span class="${base} border-sky-500/40 text-sky-300">packet_generated</span>`;
      if (status === "sent_to_cpa") return `<span class="${base} border-purple-500/40 text-purple-300">sent_to_cpa</span>`;
      if (status === "completed") return `<span class="${base} border-green-500/40 text-green-300">completed</span>`;
      if (status === "needs_info") return `<span class="${base} border-yellow-500/40 text-yellow-300">needs_info</span>`;
      return `<span class="${base} border-white/20 text-gray-200">${escHtml(status || "")}</span>`;
    }

    function getPass() {
      return (localStorage.getItem(STORAGE_KEY) || "").trim();
    }
    function setPass(p) {
      localStorage.setItem(STORAGE_KEY, String(p || "").trim());
    }
    function clearPass() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function setApiStatus(text, ok = true) {
      apiStatus.textContent = text;
      apiStatus.className = ok ? "text-green-300" : "text-red-300";
    }

    async function safeJson(res) {
      const raw = await res.text();
      try { return JSON.parse(raw); }
      catch {
        throw new Error(`Admin API returned non-JSON (HTTP ${res.status}). First 200 chars: ${raw.slice(0,200)}`);
      }
    }

    async function fetchOrders() {
      const pass = getPass();
      const st = statusFilter.value || "";
      const url = "/api/admin/orders" + (st ? `?status=${encodeURIComponent(st)}` : "");

      const res = await fetch(url, {
        method: "GET",
        headers: { "x-admin-password": pass }
      });

      const data = await safeJson(res);

      if (!res.ok || !data.success) {
        throw new Error(data.message || `Admin API error (HTTP ${res.status})`);
      }
      return data.orders || [];
    }

    async function generatePacket(tracking) {
      const pass = getPass();
      if (!pass) { alert("Not logged in."); return; }

      const ok = confirm(`Generate CPA Packet for ${tracking}?`);
      if (!ok) return;

      try {
        setApiStatus("Generating packet…", true);

        const res = await fetch("/api/generate-packet", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-password": pass
          },
          body: JSON.stringify({ tracking_number: tracking })
        });

        const data = await safeJson(res);

        if (!res.ok || !data.success) {
          throw new Error(data.message || `Generate packet failed (HTTP ${res.status})`);
        }

        alert("Packet generated successfully.");
        await renderOrders();
      } catch (e) {
        console.error(e);
        alert(e.message || "Failed to generate packet");
        setApiStatus("Error", false);
      }
    }

    async function renderOrders() {
      ordersBody.innerHTML = `<tr><td class="p-3 text-gray-400" colspan="7">Loading…</td></tr>`;
      setApiStatus("Loading…", true);

      try {
        const orders = await fetchOrders();
        setApiStatus("Connected", true);

        if (!orders.length) {
          ordersBody.innerHTML = `<tr><td class="p-3 text-gray-400" colspan="7">No orders found.</td></tr>`;
          return;
        }

        ordersBody.innerHTML = orders.map(o => {
          const tracking = escHtml(o.tracking_number || "");
          const company = escHtml(o.company_name || "");
          const project = escHtml(o.project_title || "");
          const plan = escHtml(o.service_plan || "");
          const status = o.status || "";
          const created = escHtml(fmtDate(o.created_at));

          const canGenerate = !!tracking && (status !== "packet_generated" && status !== "completed");
          const btnLabel = status === "packet_generated" ? "Packet Generated" : "Generate CPA Packet";

          return `
            <tr class="border-t border-white/10">
              <td class="p-3 font-mono text-xs">${tracking}</td>
              <td class="p-3">${company}</td>
              <td class="p-3">${project}</td>
              <td class="p-3">${plan}</td>
              <td class="p-3">${badge(status)}</td>
              <td class="p-3 text-xs text-gray-300">${created}</td>
              <td class="p-3">
                <button
                  class="px-3 py-1.5 rounded ${canGenerate ? "bg-white/10 hover:bg-white/15" : "bg-white/5 opacity-60 cursor-not-allowed"} text-xs"
                  type="button"
                  ${canGenerate ? `onclick="generatePacket('${tracking}')"` : "disabled"}
                >
                  ${btnLabel}
                </button>
              </td>
            </tr>
          `;
        }).join("");
      } catch (e) {
        setApiStatus("Error", false);
        ordersBody.innerHTML = `<tr><td class="p-3 text-red-300" colspan="7">${escHtml(e.message)}</td></tr>`;

        // If unauthorized, force relogin
        if ((e.message || "").toLowerCase().includes("unauthorized")) {
          lock("Session expired. Please sign in again.");
        }
      }
    }

    function unlock() {
      loginCard.classList.add("hidden");
      ordersWrap.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      renderOrders();
    }

    function lock(message = "") {
      ordersWrap.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      loginCard.classList.remove("hidden");
      if (message) loginMsg.textContent = message;
    }

    async function validateAndUnlock() {
      try {
        await fetchOrders();
        loginMsg.textContent = "";
        unlock();
      } catch (e) {
        clearPass();
        lock("");
      }
    }

    // Login
    loginBtn.addEventListener("click", async () => {
      const pass = adminPassEl.value.trim();
      if (!pass) { loginMsg.textContent = "Enter password."; return; }

      loginBtn.disabled = true;
      loginMsg.textContent = "Checking…";

      setPass(pass);
      try {
        await fetchOrders(); // validate password
        loginMsg.textContent = "";
        unlock();
      } catch (e) {
        const msg = e.message || "Invalid password or API not configured.";
        loginMsg.textContent = msg;
        clearPass();
        lock("");
      } finally {
        loginBtn.disabled = false;
      }
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
      clearPass();
      adminPassEl.value = "";
      lock("Logged out.");
    });

    // Show/Hide password
    togglePassBtn.addEventListener("click", () => {
      const isPw = adminPassEl.type === "password";
      adminPassEl.type = isPw ? "text" : "password";
      togglePassBtn.textContent = isPw ? "Hide" : "Show";
      togglePassBtn.setAttribute("aria-label", isPw ? "Hide password" : "Show password");
    });

    // Refresh + filter
    refreshBtn.addEventListener("click", renderOrders);
    statusFilter.addEventListener("change", renderOrders);

    // Auto-validate stored password (don’t unlock blindly)
    if (getPass()) validateAndUnlock();

    // Make generatePacket callable from inline onclick
    window.generatePacket = generatePacket;
  </script>
</body>
</html>
