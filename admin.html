<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AZ Film Credit — Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: {
      desertGold:"#E3A857", sunsetRed:"#E4572E"
    }}}}
  </script>
</head>
<body class="min-h-screen bg-black text-white">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">Admin Portal</h1>
      <a href="index.html" class="text-sm text-desertGold underline">Back to site</a>
    </div>

    <!-- Login -->
    <div id="loginCard" class="bg-white/5 border border-white/10 rounded-xl p-4 max-w-md">
      <h2 class="text-lg font-semibold mb-2">Admin Login</h2>
      <p class="text-xs text-gray-300 mb-3">Enter the admin password to view orders.</p>
      <input id="adminPass" type="password" class="w-full px-3 py-2 rounded bg-black/60 border border-white/15 text-sm"
             placeholder="Admin password" />
      <button id="loginBtn" class="mt-3 px-4 py-2 rounded bg-sunsetRed hover:bg-orange-500 font-semibold">
        Sign in
      </button>
      <p id="loginMsg" class="mt-2 text-xs text-gray-300"></p>
    </div>

    <!-- Orders -->
    <div id="ordersWrap" class="hidden">
      <div class="flex flex-wrap gap-2 items-center mt-6 mb-3">
        <select id="statusFilter" class="px-3 py-2 rounded bg-black/60 border border-white/15 text-sm">
          <option value="">All statuses</option>
          <option value="paid">paid</option>
          <option value="in_review">in_review</option>
          <option value="packet_generated">packet_generated</option>
          <option value="sent_to_cpa">sent_to_cpa</option>
          <option value="completed">completed</option>
          <option value="needs_info">needs_info</option>
        </select>
        <button id="refreshBtn" class="px-4 py-2 rounded bg-white/10 hover:bg-white/15 text-sm">
          Refresh
        </button>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-xl overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-white/5">
            <tr>
              <th class="text-left p-3">Tracking</th>
              <th class="text-left p-3">Company</th>
              <th class="text-left p-3">Project</th>
              <th class="text-left p-3">Plan</th>
              <th class="text-left p-3">Status</th>
              <th class="text-left p-3">Created</th>
              <th class="text-left p-3">Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-gray-400">
        “Generate CPA Packet” button is wired for next step (we’ll connect it to /api/generate-packet).
      </p>
    </div>
  </div>

  <script>
    const loginCard = document.getElementById("loginCard");
    const ordersWrap = document.getElementById("ordersWrap");
    const adminPassEl = document.getElementById("adminPass");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const ordersBody = document.getElementById("ordersBody");
    const statusFilter = document.getElementById("statusFilter");
    const refreshBtn = document.getElementById("refreshBtn");

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    function badge(status) {
      const base = "inline-flex px-2 py-0.5 rounded-full text-xs border";
      if (status === "paid") return `<span class="${base} border-desertGold/40 text-desertGold">paid</span>`;
      if (status === "completed") return `<span class="${base} border-green-500/40 text-green-300">completed</span>`;
      if (status === "needs_info") return `<span class="${base} border-yellow-500/40 text-yellow-300">needs_info</span>`;
      return `<span class="${base} border-white/20 text-gray-200">${status || ""}</span>`;
    }

    async function fetchOrders() {
      const pass = localStorage.getItem("azfc_admin_pass");
      const st = statusFilter.value || "";
      const url = "/api/admin/orders" + (st ? `?status=${encodeURIComponent(st)}` : "");
      const res = await fetch(url, {
        headers: { "x-admin-password": pass }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to load orders");
      return data.orders || [];
    }

    async function renderOrders() {
      ordersBody.innerHTML = `<tr><td class="p-3 text-gray-400" colspan="7">Loading…</td></tr>`;
      try {
        const orders = await fetchOrders();
        if (!orders.length) {
          ordersBody.innerHTML = `<tr><td class="p-3 text-gray-400" colspan="7">No orders found.</td></tr>`;
          return;
        }
        ordersBody.innerHTML = orders.map(o => `
          <tr class="border-t border-white/10">
            <td class="p-3 font-mono text-xs">${o.tracking_number}</td>
            <td class="p-3">${o.company_name || ""}</td>
            <td class="p-3">${o.project_title || ""}</td>
            <td class="p-3">${o.service_plan || ""}</td>
            <td class="p-3">${badge(o.status)}</td>
            <td class="p-3 text-xs text-gray-300">${fmtDate(o.created_at)}</td>
            <td class="p-3">
              <button class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/15 text-xs"
                onclick="alert('Next step: call /api/generate-packet for ${o.tracking_number}')">
                Generate CPA Packet
              </button>
            </td>
          </tr>
        `).join("");
      } catch (e) {
        ordersBody.innerHTML = `<tr><td class="p-3 text-red-300" colspan="7">${e.message}</td></tr>`;
      }
    }

    function unlock() {
      loginCard.classList.add("hidden");
      ordersWrap.classList.remove("hidden");
      renderOrders();
    }

    loginBtn.addEventListener("click", async () => {
      const pass = adminPassEl.value.trim();
      if (!pass) { loginMsg.textContent = "Enter password."; return; }
      localStorage.setItem("azfc_admin_pass", pass);
      loginMsg.textContent = "Checking…";
      try {
        await fetchOrders();
        loginMsg.textContent = "";
        unlock();
      } catch (e) {
        loginMsg.textContent = "Invalid password or API not configured.";
        localStorage.removeItem("azfc_admin_pass");
      }
    });

    refreshBtn.addEventListener("click", renderOrders);
    statusFilter.addEventListener("change", renderOrders);

    // Auto-login if stored
    if (localStorage.getItem("azfc_admin_pass")) unlock();
  </script>
</body>
</html>
